#! /bin/sh

USAGE="git test-range RANGE COMMAND..."

LONG_USAGE="Run COMMAND for each commit in the specified RANGE in reverse order,
stopping if the command fails.  The return code is that of the last
command executed (i.e., 0 only if the command succeeded for every
commit in the range)."

SUBDIRECTORY_OK=TRUE

. "$(git --exec-path)/git-sh-setup"

test_revision() {
    r="$1"
    shift
    git --no-pager log -1 --decorate $r &&
    git co $r &&
    "$@"
}

if test $# -lt 2
then
    usage
    exit 1
fi

require_clean_work_tree "test-range"

range="$1"
shift

head=$(git symbolic-ref HEAD 2>/dev/null || git rev-parse HEAD)

for r in $(git rev-list --reverse "$range")
do
    if ! test_revision $r "$@"
    then
        retcode=$?
        echo
        echo "*******************************************************************************"
        echo "FAILED ON COMMIT $r:"
        echo
        git --no-pager log -1 --decorate $r
        echo "*******************************************************************************"
        echo
        echo "FAILURE!"
        exit $retcode
    fi
done

git checkout -f ${head#refs/heads/}

echo
echo "ALL TESTS SUCCESSFUL"
exit 0

